{{template "header" .}}
<style>
    main {
        padding: 2rem;
        width: clamp(300px, 80%, 1400px);
        margin: 0 auto;
        height: 88vh;
        overflow-y: auto;
    }
    .sidebar {
        display: none;
        position: absolute;
        right: 0;
        top: 106px;
        width: 400px;
        height: 88vh;
        background-color: var(--container-color);
        color: #fff;
        padding: 2rem;
        z-index: 2;
    }
    .side-flex {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
    }
    .sidebar-content{
        border: #fff solid 1px;
        overflow-y: auto;
    }
    .side-title, .side-text{
        color:var(--text-color);
    }
    .side-content{
        margin: 0px 30px;
    }

    .output {
        border: 5px solid var(--accent-color);
        border-radius: 5px;
        background-color: var(--container-color);
        position: relative;
    }
    

    .dashboard {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        grid-auto-rows: minmax(100px, auto);
        gap: 1rem;
    }

    .map {
        grid-column: span 12;
        grid-row: span 4;
        position: relative;
    }

    .input-1, .input-2 {
        grid-column: span 2;
        grid-row: span 1;
        height: 50px;
    }

    .kpi-1 {
        grid-column: 1 / span 3;
        grid-row: span 2;
    }

    .kpi-2, .kpi-3 {
        grid-column: span 3;
        grid-row: span 2;
    }

    .table, .chart {
        grid-column: span 6;
        grid-row: span 4;
    }

    .more-info {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background-color: var(--accent-color);
        border-radius: 50%;
        padding: 0.5rem;
        z-index: 1;
    }

    .tooltip {
        position: absolute;
        display: none;
        border: 3px solid var(--accent-color);
        background-color: var(--container-color);
        width: clamp(200px, 300px, 400px);
        z-index: 1;
    }

    .node-tooltip {
        position: absolute;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px;
        border-radius: 5px;
        font-size: 12px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        display: none;
        pointer-events: none;
    }
    .kpi-title{
        margin : 0 30px;
        text-align: center;
        font-size: 1.5rem;
    }
    .kpi-card{
        text-align: center;
        font-size: 3rem;
    }
</style>

<main>
    <h1>Dashboard</h1>

    <div class="tooltip">
        <div class="tooltip-content">
            <h3>Component 1</h3>
            <p>Some content</p>
        </div>
    </div>

    <div class="dashboard">
        <div class="dashboard-item map output component-1">
            <canvas id="nodeCanvas"></canvas>
            <div class="node-tooltip" id="nodeTooltip"></div>
            <div class="more-info"></div>
        </div>
        <div class="dashboard-item input-1 component-2">
            <label style="display: inline;">Machine: </label>
            <select name="cars" id="cars" style="display: inline;">
                <option value="All Machines">All Machines</option>
                <option value="Machine-01">Machine-01</option>
                <option value="Machine-02">Machine-02</option>
                <option value="Machine-03">Machine-03</option>
            </select>
        </div>
        <div class="dashboard-item input-2 component-3">
            <label style="display: inline;">Shifts: </label>
            <select name="cars" id="cars" style="display: inline;">
                <option value="All Shifts">All Shifts</option>
                <option value="Blue">Blue</option>
                <option value="Red">Red</option>
                <option value="Green">Green</option>
            </select>
        </div>
        <div class="dashboard-item kpi-1 output component-4">
            <div class="more-info"></div>
            <h2 class="kpi-title">Part's Per Minute</h2>
            <h1 class =" kpi-card"> 100 </h1>
        </div>
        <div class="dashboard-item kpi-2 output component-5">
            <div class="more-info"></div>
            <h2 class="kpi-title">Total Amount Produced</h2>
            <h1 class=" kpi-card"> 100 </h1>
        </div>
        <div class="dashboard-item kpi-2 output component-6">
            <div class="more-info"></div>
            <h2 class="kpi-title">Amount Produced This Shift</h2>
            <h1 class=" kpi-card"> 100 </h1>
        </div>
        <div class="dashboard-item chart output component-7">
            <div class="more-info"></div>
            
            <canvas id="myChart" width="300" height="300"></canvas>
        </div>
        <div class="dashboard-item table output component-8">
            <div class="more-info"></div>
            <div id="wrapper"></div>
        </div>
    </div>
</main>

<section class="sidebar">
    <div class="side-flex">
    <div class="sidebar-content">
        <div class ="side-item data-sources">
            <h2 class="side-title">Data Sources</h2>
            <div class="side-content">
                <ul>
                    <li>Source 1</li>
                    <li>Source 2</li>
                    <li>Source 3</li>
                    <li>Source 4</li>
                </ul>
            </div>
        </div>
        <div class="side-item query">
            <h2 class="side-title">Queries</h2>
        </div>
        <div class="side-item performance">
            <h2 class="side-title">Performance</h2>
        </div>
        <div class="side-item raw-output">
            <h2 class="side-title">Raw Output</h2>
        </div>
        <div class="side-item input-elements">
            <h2 class="side-title">Input Elements</h2>
        </div>
        
    </div>
    <button class="btn btn-primary close" onclick="document.querySelector('.sidebar').style.display = 'none'">
        Close
    </button>
    </div>
</section>
<script>
    // universal data source object
    const dataSource = {
        machines: [
            {
                name: "Machine-01",
                email: "john@example.com",
                phone: "(353) 01 222 3333",
                produced: 120,
                partsPerMinute: 100,
                producedThisShift: 80
            },
            {
                name: "Machine-02",
                email: "mark@gmail.com",
                phone: "(01) 22 888 4444",
                produced: 150,
                partsPerMinute: 110,
                producedThisShift: 90
            },
            {
                name: "Machine-03",
                email: "eoin@gmail.com",
                phone: "0097 22 654 00033",
                produced: 130,
                partsPerMinute: 105,
                producedThisShift: 85
            }
        ]
    };

    document.addEventListener('DOMContentLoaded', function () {
        // sidebar and tooltip behavior on the more-info icons
        document.querySelectorAll('.more-info').forEach(info => {
            info.addEventListener('click', () => {
                document.querySelector('.sidebar').style.display = 'block';
            });
            info.addEventListener('mouseover', (event) => {
                document.querySelector('.tooltip').style.display = 'flex';
                document.querySelector('.tooltip').style.top = `${event.clientY}px`;
                document.querySelector('.tooltip').style.left = `${event.clientX}px`;
            });
            info.addEventListener('mouseout', () => {
                document.querySelector('.tooltip').style.display = 'none';
            });
        });

        // whenever an input (select) changes, update the universal data and re-render everything
        document.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', updateComponentsFromInput);
        });

        // initial render of all components
        reRenderAll();
    });

    // simulate updating the dataSource when an input changes
    function updateComponentsFromInput(event) {
        // For demonstration, we update each machine with new random values.
        dataSource.machines = dataSource.machines.map(machine => ({
            ...machine,
            produced: Math.floor(Math.random() * 100 + 100),         // range: 100-200
            partsPerMinute: Math.floor(Math.random() * 70 + 50),       // range: 50-120
            producedThisShift: Math.floor(Math.random() * 70 + 80)     // range: 80-150
        }));
        reRenderAll();
    }

    // re-render all components (map remains unchanged)
    function reRenderAll() {
        createMap();
        createGrid();
        createChart();
        updateKPIs();
    }

    // update KPI values based on data from the universal data source
    function updateKPIs() {
        const averagePartsPerMinute = Math.round(
            dataSource.machines.reduce((sum, m) => sum + m.partsPerMinute, 0) / dataSource.machines.length
        );
        const totalProduced = dataSource.machines.reduce((sum, m) => sum + m.produced, 0);
        const totalProducedThisShift = dataSource.machines.reduce((sum, m) => sum + m.producedThisShift, 0);

        const kpiCards = document.querySelectorAll('.kpi-card');
        if (kpiCards.length >= 3) {
            // Assumes the first KPI shows parts per minute, the second total produced,
            // and the third produced this shift.
            kpiCards[0].textContent = averagePartsPerMinute;
            kpiCards[1].textContent = totalProduced;
            kpiCards[2].textContent = totalProducedThisShift;
        }
    }

    // update Chart.js chart so that x-axis the machine names and y-axis the produced amounts
    function createChart() {
        const ctx = document.getElementById('myChart').getContext('2d');
        const labels = dataSource.machines.map(machine => machine.name);
        const producedData = dataSource.machines.map(machine => machine.produced);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Products Produced',
                    data: producedData,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // update grid to display rows (one per machine) from the universal data source
    function createGrid() {
        const gridData = dataSource.machines.map(machine => [machine.name, machine.email, machine.phone]);
        new gridjs.Grid({
            columns: ["Name", "Email", "Phone Number"],
            data: gridData
        }).render(document.getElementById("wrapper"));
    }

    // The createMap() function remains unchanged
    function createMap() {
        const canvas = document.getElementById("nodeCanvas");
        const ctx = canvas.getContext("2d");
        const tooltip = document.getElementById("nodeTooltip");

        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;

        let scale = 1;
        let originX = 0;
        let originY = 0;

        class Node {
            constructor(name, x, y) {
                this.name = name;
                this.x = x;
                this.y = y;
                this.radius = 20;
                this.dataCount = Math.floor(Math.random() * 100);
            }

            draw() {
                ctx.fillStyle = "#1a1a2e";
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = "#ffffff";
                ctx.stroke();

                ctx.fillStyle = "#ffffff";
                ctx.font = "12px Arial";
                ctx.textAlign = "center";
                ctx.fillText(this.name, this.x, this.y + 5);
            }
        }

        class Link {
            constructor(node1, node2) {
                this.node1 = node1;
                this.node2 = node2;
            }

            draw() {
                ctx.strokeStyle = "#4455aa";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(this.node1.x, this.node1.y);
                ctx.lineTo(this.node2.x, this.node2.y);
                ctx.stroke();
            }
        }

        const nodes = [
            new Node("Node A", 100, 100),
            new Node("Node B", 200, 150),
            new Node("Node C", 300, 200),
            new Node("Node D", 400, 250),
            new Node("Node E", 500, 300),
            new Node("Node F", 600, 350),
            new Node("Node G", 700, 400)
        ];

        const links = [
            new Link(nodes[0], nodes[1]),
            new Link(nodes[1], nodes[2]),
            new Link(nodes[2], nodes[3]),
            new Link(nodes[3], nodes[4]),
            new Link(nodes[4], nodes[5]),
            new Link(nodes[5], nodes[6])
        ];

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(originX, originY);
            ctx.scale(scale, scale);
            ctx.fillStyle = "#f0f0f0"; // Background color
            ctx.fillRect(-originX, -originY, canvas.width / scale, canvas.height / scale);
            links.forEach(link => link.draw());
            nodes.forEach(node => node.draw());
            ctx.restore();
        }

        function getMousePos(event) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (event.clientX - rect.left - originX) / scale,
                y: (event.clientY - rect.top - originY) / scale
            };
        }

        function showTooltip(event) {
            const mousePos = getMousePos(event);
            let found = false;
            nodes.forEach(node => {
                const distance = Math.sqrt(
                    (mousePos.x - node.x) ** 2 + (mousePos.y - node.y) ** 2
                );
                if (distance < node.radius) {
                    found = true;
                    tooltip.style.display = "block";
                    tooltip.style.left = `${event.pageX + 10}px`;
                    tooltip.style.top = `${event.pageY - 30}px`;
                    tooltip.innerHTML = `
                        <strong>${node.name}</strong><br>
                        Data: ${node.dataCount} items
                    `;
                }
            });
            if (!found) {
                tooltip.style.display = "none";
            }
        }

        function zoom(event) {
            event.preventDefault();
            const mousePos = getMousePos(event);
            const zoomFactor = 1.1;
            if (event.deltaY < 0) {
                scale *= zoomFactor;
                originX = mousePos.x - (mousePos.x - originX) * zoomFactor;
                originY = mousePos.y - (mousePos.y - originY) * zoomFactor;
            } else {
                scale /= zoomFactor;
                originX = mousePos.x - (mousePos.x - originX) / zoomFactor;
                originY = mousePos.y - (mousePos.y - originY) / zoomFactor;
            }
            draw();
        }

        function pan(event) {
            if (event.buttons !== 1) return;
            originX += event.movementX;
            originY += event.movementY;
            draw();
        }

        canvas.addEventListener("mousemove", showTooltip);
        canvas.addEventListener("wheel", zoom);
        canvas.addEventListener("mousemove", pan);

        draw();
    }
</script>